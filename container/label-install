#!/bin/sh -eu

# This is the install script for gdm when run in a privileged
# container.
#
# The host file system must be mounted at /host

cd /
PATH="/usr/bin:/usr/sbin"

if [ ! -d /host/etc ] || [ ! -d /host/proc ] || [ ! -d /host/run ]; then
    echo "gdm-install: host file system is not mounted at /host" >&2
    exit 1
fi
if [ -f /host/usr/bin/gdm ]; then
    echo "gdm-install: gdm must not be installed in the host" >&2
    exit 1
fi
if [ ! -f /host/usr/lib*/libnss_systemd.so.* ]; then
    echo "gdm-install: nss-systemd package must be installed on host system" >&2
    exit 1
fi
grep -q 'passwd.*systemd' /host/etc/nsswitch.conf /host/usr/etc/nsswitch.conf
RETVAL=$?
if [ $RETVAL -ne 0 ]; then
    echo "gdm-install: nss-systemd is not configured in nsswitch.conf, check man nss-systemd " >&2
    exit 1
fi

# For podman, install a systemd unit for starting on boot and userdb entries
if [ "${container:-}" = podman ]; then
    if [ ! -e /host/etc/systemd/system/gdm.service ]; then
	mkdir -p /host/etc/systemd/system/
	sed -e "s,%IMAGE%,${IMAGE},g" /container/systemd/gdm.service > /host/etc/systemd/system/gdm.service
    fi
    if [ ! -e /host/etc/userdb/gdm.user ]; then
	mkdir -p /host/etc/userdb/
	cp -avr /container/userdb/* /host/etc/userdb
    fi
fi

